!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.SerializeAddon=e():t.SerializeAddon=e()}(this,(function(){return(()=>{"use strict";var t={};return{44:function(t,e){var r,o=this&&this.__extends||(r=function(t,e){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},r(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function o(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)});function i(t,e,r){return Math.max(e,Math.min(t,r))}Object.defineProperty(e,"__esModule",{value:!0}),e.HTMLSerializeHandler=e.SerializeAddon=void 0;var n=function(){function t(t){this._buffer=t}return t.prototype.serialize=function(t){var e=this._buffer.getNullCell(),r=this._buffer.getNullCell(),o=e,i=t.start.x,n=t.end.x,s=t.start.y,l=t.end.y;this._beforeSerialize(n-i,i,n);for(var u=i;u<=n;u++){var a=this._buffer.getLine(u);if(a)for(var h=u!==t.start.x?0:s,_=u!==t.end.x?a.length:l,c=h;c<_;c++){var f=a.getCell(c,o===e?r:e);f?(this._nextCell(f,o,u,c),o=f):console.warn("Can't get cell at row=".concat(u,", col=").concat(c))}this._rowEnd(u,u===n)}return this._afterSerialize(),this._serializeString()},t.prototype._nextCell=function(t,e,r,o){},t.prototype._rowEnd=function(t,e){},t.prototype._beforeSerialize=function(t,e,r){},t.prototype._afterSerialize=function(){},t.prototype._serializeString=function(){return""},t}();function s(t,e){return t.getFgColorMode()===e.getFgColorMode()&&t.getFgColor()===e.getFgColor()}function l(t,e){return t.getBgColorMode()===e.getBgColorMode()&&t.getBgColor()===e.getBgColor()}function u(t,e){return t.isInverse()===e.isInverse()&&t.isBold()===e.isBold()&&t.isUnderline()===e.isUnderline()&&t.isBlink()===e.isBlink()&&t.isInvisible()===e.isInvisible()&&t.isItalic()===e.isItalic()&&t.isDim()===e.isDim()&&t.isStrikethrough()===e.isStrikethrough()}var a=function(t){function e(e,r){var o=t.call(this,e)||this;return o._terminal=r,o._rowIndex=0,o._allRows=new Array,o._allRowSeparators=new Array,o._currentRow="",o._nullCellCount=0,o._cursorStyle=o._buffer.getNullCell(),o._cursorStyleRow=0,o._cursorStyleCol=0,o._backgroundCell=o._buffer.getNullCell(),o._firstRow=0,o._lastCursorRow=0,o._lastCursorCol=0,o._lastContentCursorRow=0,o._lastContentCursorCol=0,o._thisRowLastChar=o._buffer.getNullCell(),o._thisRowLastSecondChar=o._buffer.getNullCell(),o._nextRowFirstChar=o._buffer.getNullCell(),o}return o(e,t),e.prototype._beforeSerialize=function(t,e,r){this._allRows=new Array(t),this._lastContentCursorRow=e,this._lastCursorRow=e,this._firstRow=e},e.prototype._rowEnd=function(t,e){var r;this._nullCellCount>0&&!l(this._cursorStyle,this._backgroundCell)&&(this._currentRow+="[".concat(this._nullCellCount,"X"));var o="";if(!e){t-this._firstRow>=this._terminal.rows&&(null===(r=this._buffer.getLine(this._cursorStyleRow))||void 0===r||r.getCell(this._cursorStyleCol,this._backgroundCell));var i=this._buffer.getLine(t),n=this._buffer.getLine(t+1);if(n.isWrapped){o="";var s=i.getCell(i.length-1,this._thisRowLastChar),u=i.getCell(i.length-2,this._thisRowLastSecondChar),a=n.getCell(0,this._nextRowFirstChar),h=a.getWidth()>1,_=!1;(a.getChars()&&h?this._nullCellCount<=1:this._nullCellCount<=0)&&((s.getChars()||0===s.getWidth())&&l(s,a)&&(_=!0),h&&(u.getChars()||0===u.getWidth())&&l(s,a)&&l(u,a)&&(_=!0)),_||(o="-".repeat(this._nullCellCount+1),o+="[1D[1X",this._nullCellCount>0&&(o+="[A",o+="[".concat(i.length-this._nullCellCount,"C"),o+="[".concat(this._nullCellCount,"X"),o+="[".concat(i.length-this._nullCellCount,"D"),o+="[B"),this._lastContentCursorRow=t+1,this._lastContentCursorCol=0,this._lastCursorRow=t+1,this._lastCursorCol=0)}else o="\r\n",this._lastCursorRow=t+1,this._lastCursorCol=0}this._allRows[this._rowIndex]=this._currentRow,this._allRowSeparators[this._rowIndex++]=o,this._currentRow="",this._nullCellCount=0},e.prototype._diffStyle=function(t,e){var r=[],o=!s(t,e),i=!l(t,e),n=!u(t,e);if(o||i||n)if(t.isAttributeDefault())e.isAttributeDefault()||r.push(0);else{if(o){var a=t.getFgColor();t.isFgRGB()?r.push(38,2,a>>>16&255,a>>>8&255,255&a):t.isFgPalette()?a>=16?r.push(38,5,a):r.push(8&a?90+(7&a):30+(7&a)):r.push(39)}i&&(a=t.getBgColor(),t.isBgRGB()?r.push(48,2,a>>>16&255,a>>>8&255,255&a):t.isBgPalette()?a>=16?r.push(48,5,a):r.push(8&a?100+(7&a):40+(7&a)):r.push(49)),n&&(t.isInverse()!==e.isInverse()&&r.push(t.isInverse()?7:27),t.isBold()!==e.isBold()&&r.push(t.isBold()?1:22),t.isUnderline()!==e.isUnderline()&&r.push(t.isUnderline()?4:24),t.isBlink()!==e.isBlink()&&r.push(t.isBlink()?5:25),t.isInvisible()!==e.isInvisible()&&r.push(t.isInvisible()?8:28),t.isItalic()!==e.isItalic()&&r.push(t.isItalic()?3:23),t.isDim()!==e.isDim()&&r.push(t.isDim()?2:22),t.isStrikethrough()!==e.isStrikethrough()&&r.push(t.isStrikethrough()?9:29))}return r},e.prototype._nextCell=function(t,e,r,o){if(0!==t.getWidth()){var i=""===t.getChars(),n=this._diffStyle(t,this._cursorStyle);if(i?!l(this._cursorStyle,t):n.length>0){this._nullCellCount>0&&(l(this._cursorStyle,this._backgroundCell)||(this._currentRow+="[".concat(this._nullCellCount,"X")),this._currentRow+="[".concat(this._nullCellCount,"C"),this._nullCellCount=0),this._lastContentCursorRow=this._lastCursorRow=r,this._lastContentCursorCol=this._lastCursorCol=o,this._currentRow+="[".concat(n.join(";"),"m");var s=this._buffer.getLine(r);void 0!==s&&(s.getCell(o,this._cursorStyle),this._cursorStyleRow=r,this._cursorStyleCol=o)}i?this._nullCellCount+=t.getWidth():(this._nullCellCount>0&&(l(this._cursorStyle,this._backgroundCell)||(this._currentRow+="[".concat(this._nullCellCount,"X")),this._currentRow+="[".concat(this._nullCellCount,"C"),this._nullCellCount=0),this._currentRow+=t.getChars(),this._lastContentCursorRow=this._lastCursorRow=r,this._lastContentCursorCol=this._lastCursorCol=o+t.getWidth())}},e.prototype._serializeString=function(){var t=this._allRows.length;this._buffer.length-this._firstRow<=this._terminal.rows&&(t=this._lastContentCursorRow+1-this._firstRow,this._lastCursorCol=this._lastContentCursorCol,this._lastCursorRow=this._lastContentCursorRow);for(var e="",r=0;r<t;r++)e+=this._allRows[r],r+1<t&&(e+=this._allRowSeparators[r]);var o,i=this._buffer.baseY+this._buffer.cursorY,n=this._buffer.cursorX;(i!==this._lastCursorRow||n!==this._lastCursorCol)&&((o=i-this._lastCursorRow)>0?e+="[".concat(o,"B"):o<0&&(e+="[".concat(-o,"A")),function(t){t>0?e+="[".concat(t,"C"):t<0&&(e+="[".concat(-t,"D"))}(n-this._lastCursorCol));var s=this._terminal._core._inputHandler._curAttrData,l=this._diffStyle(s,this._cursorStyle);return l.length>0&&(e+="[".concat(l.join(";"),"m")),e},e}(n),h=function(){function t(){}return t.prototype.activate=function(t){this._terminal=t},t.prototype._serializeBuffer=function(t,e,r){var o=e.length,n=new a(e,t),s=void 0===r?o:i(r+t.rows,0,o);return n.serialize({start:{x:o-s,y:0},end:{x:o-1,y:t.cols}})},t.prototype._serializeBufferAsHTML=function(t,e){var r,o,n=t.buffer.active,s=new _(n,t,e);if(null===(r=e.onlySelection)||void 0===r||!r){var l=n.length,u=e.scrollback,a=void 0===u?l:i(u+t.rows,0,l);return s.serialize({start:{x:l-a,y:0},end:{x:l-1,y:t.cols}})}var h=null===(o=this._terminal)||void 0===o?void 0:o.getSelectionPosition();return void 0!==h?s.serialize({start:{x:h.start.y,y:h.start.x},end:{x:h.end.y,y:h.end.x}}):""},t.prototype._serializeModes=function(t){var e="",r=t.modes;if(r.applicationCursorKeysMode&&(e+="[?1h"),r.applicationKeypadMode&&(e+="[?66h"),r.bracketedPasteMode&&(e+="[?2004h"),r.insertMode&&(e+="[4h"),r.originMode&&(e+="[?6h"),r.reverseWraparoundMode&&(e+="[?45h"),r.sendFocusMode&&(e+="[?1004h"),!1===r.wraparoundMode&&(e+="[?7l"),"none"!==r.mouseTrackingMode)switch(r.mouseTrackingMode){case"x10":e+="[?9h";break;case"vt200":e+="[?1000h";break;case"drag":e+="[?1002h";break;case"any":e+="[?1003h"}return e},t.prototype.serialize=function(t){if(!this._terminal)throw new Error("Cannot use addon until it has been loaded");var e=this._serializeBuffer(this._terminal,this._terminal.buffer.normal,null==t?void 0:t.scrollback);if(!(null==t?void 0:t.excludeAltBuffer)&&"alternate"===this._terminal.buffer.active.type){var r=this._serializeBuffer(this._terminal,this._terminal.buffer.alternate,void 0);e+="[?1049h[H".concat(r)}return(null==t?void 0:t.excludeModes)||(e+=this._serializeModes(this._terminal)),e},t.prototype.serializeAsHTML=function(t){if(!this._terminal)throw new Error("Cannot use addon until it has been loaded");return this._serializeBufferAsHTML(this._terminal,t||{})},t.prototype.dispose=function(){},t}();e.SerializeAddon=h;var _=function(t){function e(e,r,o){var i=t.call(this,e)||this;return i._terminal=r,i._options=o,i._currentRow="",i._htmlContent="",i._colors=r._core._colorManager.colors,i}return o(e,t),e.prototype._padStart=function(t,e,r){return e>>=0,r=null!=r?r:" ",t.length>e?t:((e-=t.length)>r.length&&(r+=r.repeat(e/r.length)),r.slice(0,e)+t)},e.prototype._beforeSerialize=function(t,e,r){var o,i,n,s,l;this._htmlContent+="<html><body>\x3c!--StartFragment--\x3e<pre>";var u="#000000",a="#ffffff";null!==(o=this._options.includeGlobalBackground)&&void 0!==o&&o&&(u=null!==(n=null===(i=this._terminal.options.theme)||void 0===i?void 0:i.foreground)&&void 0!==n?n:"#ffffff",a=null!==(l=null===(s=this._terminal.options.theme)||void 0===s?void 0:s.background)&&void 0!==l?l:"#000000");var h=[];h.push("color: "+u+";"),h.push("background-color: "+a+";"),h.push("font-family: "+this._terminal.options.fontFamily+";"),h.push("font-size: "+this._terminal.options.fontSize+"px;"),this._htmlContent+="<div style='"+h.join(" ")+"'>"},e.prototype._afterSerialize=function(){this._htmlContent+="</div>",this._htmlContent+="</pre>\x3c!--EndFragment--\x3e</body></html>"},e.prototype._rowEnd=function(t,e){this._htmlContent+="<div><span>"+this._currentRow+"</span></div>",this._currentRow=""},e.prototype._getHexColor=function(t,e){var r=this,o=e?t.getFgColor():t.getBgColor();return(e?t.isFgRGB():t.isBgRGB())?[o>>16&255,o>>8&255,255&o].map((function(t){return r._padStart(t.toString(16),2,"0")})).join(""):(e?t.isFgPalette():t.isBgPalette())?this._colors.ansi[o].css:void 0},e.prototype._diffStyle=function(t,e){var r=[],o=!s(t,e),i=!l(t,e),n=!u(t,e);if(o||i||n){var a=this._getHexColor(t,!0);a&&r.push("color: "+a+";");var h=this._getHexColor(t,!1);return h&&r.push("background-color: "+h+";"),t.isInverse()&&r.push("color: #000000; background-color: #BFBFBF;"),t.isBold()&&r.push("font-weight: bold;"),t.isUnderline()&&r.push("text-decoration: underline;"),t.isBlink()&&r.push("text-decoration: blink;"),t.isInvisible()&&r.push("visibility: hidden;"),t.isItalic()&&r.push("font-style: italic;"),t.isDim()&&r.push("opacity: 0.5;"),t.isStrikethrough()&&r.push("text-decoration: line-through;"),r}},e.prototype._nextCell=function(t,e,r,o){if(0!==t.getWidth()){var i=""===t.getChars(),n=this._diffStyle(t,e);n&&(this._currentRow+=0===n.length?"</span><span>":"</span><span style='"+n.join(" ")+"'>"),this._currentRow+=i?" ":t.getChars()}},e.prototype._serializeString=function(){return this._htmlContent},e}(n);e.HTMLSerializeHandler=_}}[44](0,t),t})()}));